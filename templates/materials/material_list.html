<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>原料管理システム - 完全版</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-blue: #1e40af;
            --primary-blue-light: #3b82f6;
            --success-green: #059669;
            --warning-orange: #d97706;
            --text-dark: #1f2937;
            --bg-light: #f8fafc;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.5;
        }

        .navbar {
            background-color: var(--primary-blue) !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card {
            border: none;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .card-header {
            background-color: var(--primary-blue);
            color: white;
            font-weight: 600;
            border-radius: 8px 8px 0 0 !important;
        }

        .stats-card {
            transition: transform 0.2s ease;
        }

        .stats-card:hover {
            transform: translateY(-2px);
        }

        .table {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            font-size: 0.875rem;
        }

        .table thead th {
            background-color: var(--primary-blue);
            color: white;
            border: none;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.025em;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table tbody tr:hover {
            background-color: #f1f5f9;
        }

        .badge {
            font-size: 0.75rem;
            font-weight: 500;
        }

        .btn {
            border-radius: 6px;
            font-weight: 500;
        }

        .form-control, .form-select {
            border-radius: 6px;
            border: 1px solid #d1d5db;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-blue-light);
            box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
        }

        .text-truncate-custom {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .material-id {
            font-family: 'Monaco', 'Consolas', monospace;
            font-weight: bold;
            font-size: 0.875rem;
        }

        .compact-table td {
            padding: 0.5rem 0.75rem;
            vertical-align: middle;
        }

        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-industry me-2"></i>原料管理システム
                <span class="badge bg-success ms-2">完全版</span>
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{% url 'materials:dashboard' %}">
                    <i class="fas fa-tachometer-alt me-1"></i>ダッシュボード
                </a>
                <a class="nav-link" href="/admin/">
                    <i class="fas fa-cog me-1"></i>システム管理
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <!-- ページヘッダー -->
        <div class="row mb-3">
            <div class="col">
                <h1 class="h3 text-primary mb-1">
                    <i class="fas fa-flask me-2"></i>原料管理システム
                    <small class="text-muted">全原料データ表示</small>
                </h1>
                <p class="text-muted mb-0">原料マスタ詳細.csvから読み込んだ全ての原料データを管理</p>
            </div>
        </div>

        <!-- 統計ダッシュボード -->
        <div class="row mb-3">
            <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
                <div class="card stats-card h-100">
                    <div class="card-body p-3 text-center">
                        <div class="h4 text-primary mb-1">{{ total_count }}</div>
                        <div class="small text-muted">表示中</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
                <div class="card stats-card h-100">
                    <div class="card-body p-3 text-center">
                        <div class="h4 text-success mb-1">{{ materials_in_db }}</div>
                        <div class="small text-muted">総原料数</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
                <div class="card stats-card h-100">
                    <div class="card-body p-3 text-center">
                        <div class="h4 text-info mb-1">{{ manufacturers|length }}</div>
                        <div class="small text-muted">製造所数</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
                <div class="card stats-card h-100">
                    <div class="card-body p-3 text-center">
                        <div class="h4 text-warning mb-1">{{ suppliers|length }}</div>
                        <div class="small text-muted">販売者数</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
                <div class="card stats-card h-100">
                    <div class="card-body p-3 text-center">
                        <div class="h4 text-secondary mb-1">{{ categories_with_count|length }}</div>
                        <div class="small text-muted">カテゴリ数</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
                <div class="card stats-card h-100">
                    <div class="card-body p-3 text-center">
                        <div class="h4 text-danger mb-1">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="small text-muted">データ完全</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CSV読み込み機能 -->
        <div class="row mb-3">
            <div class="col">
                <div class="card">
                    <div class="card-header py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-upload me-2"></i>データ管理</span>
                            <small class="text-light">原料マスタ詳細.csv (621件)</small>
                        </div>
                    </div>
                    <div class="card-body py-2">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    CSVファイルから全ての原料データを読み込み、データベースに保存します
                                </small>
                            </div>
                            <div class="col-md-4 text-end">
                                <button type="button" class="btn btn-outline-info btn-sm me-2" onclick="analyzeCSV()">
                                    <i class="fas fa-search me-1"></i>CSV分析
                                </button>
                                <form method="post" action="{% url 'materials:load_csv_data' %}" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-success btn-sm">
                                        <i class="fas fa-download me-1"></i>CSV読み込み
                                    </button>
                                </form>
                            </div>
                        </div>
                        <!-- CSV分析結果表示エリア -->
                        <div id="csvAnalysisResult" class="mt-2" style="display: none;">
                            <hr class="my-2">
                            <div id="csvAnalysisContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 検索・フィルタ -->
        <div class="row mb-3">
            <div class="col">
                <div class="card">
                    <div class="card-header py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-search me-2"></i>検索・フィルタ</span>
                            {% if has_filters %}
                            <a href="{% url 'materials:material_list' %}" class="btn btn-outline-light btn-sm">
                                <i class="fas fa-times me-1"></i>クリア
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body py-2">
                        <form method="get">
                            <div class="row g-2">
                                <div class="col-md-3">
                                    <input type="text" class="form-control form-control-sm" name="search"
                                           value="{{ search_query }}" placeholder="原料名・ID・製造所・販売者を検索">
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select form-select-sm" name="manufacturer">
                                        <option value="">すべての製造所</option>
                                        {% for manufacturer in manufacturers %}
                                        <option value="{{ manufacturer }}" {% if manufacturer == manufacturer_filter %}selected{% endif %}>
                                            {{ manufacturer|truncatechars:20 }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select form-select-sm" name="supplier">
                                        <option value="">すべての販売者</option>
                                        {% for supplier in suppliers %}
                                        <option value="{{ supplier }}" {% if supplier == supplier_filter %}selected{% endif %}>
                                            {{ supplier|truncatechars:20 }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-1">
                                    <input type="number" class="form-control form-control-sm" name="price_min"
                                           value="{{ price_min }}" placeholder="最低価格">
                                </div>
                                <div class="col-md-1">
                                    <input type="number" class="form-control form-control-sm" name="price_max"
                                           value="{{ price_max }}" placeholder="最高価格">
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select form-select-sm" name="per_page">
                                        <option value="50" {% if per_page == 50 %}selected{% endif %}>50件表示</option>
                                        <option value="100" {% if per_page == 100 %}selected{% endif %}>100件表示</option>
                                        <option value="200" {% if per_page == 200 %}selected{% endif %}>200件表示</option>
                                        <option value="500" {% if per_page == 500 %}selected{% endif %}>500件表示</option>
                                        <option value="1000" {% if per_page == 1000 %}selected{% endif %}>全件表示</option>
                                    </select>
                                </div>
                                <div class="col-md-1">
                                    <button type="submit" class="btn btn-primary btn-sm w-100">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 原料データテーブル -->
        <div class="row">
            <div class="col">
                <div class="card">
                    <div class="card-header py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>
                                <i class="fas fa-table me-2"></i>原料一覧
                                <span class="badge bg-light text-dark ms-2">{{ total_count }}件</span>
                                {% if has_filters %}
                                <span class="badge bg-warning text-dark">フィルタ適用中</span>
                                {% endif %}
                            </span>
                            <small class="text-light">ページ {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</small>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 70vh;">
                            <table class="table table-hover table-sm mb-0 compact-table">
                                <thead>
                                    <tr>
                                        <th style="width: 80px;">原料ID</th>
                                        <th style="width: 250px;">原料名</th>
                                        <th style="width: 150px;">製造所</th>
                                        <th style="width: 150px;">販売者</th>
                                        <th style="width: 100px;">荷姿</th>
                                        <th style="width: 80px;">単価</th>
                                        <th style="width: 80px;">重量</th>
                                        <th style="width: 80px;">区分</th>
                                        <th style="width: 200px;">備考</th>
                                        <th style="width: 60px;">詳細</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for material in page_obj %}
                                    <tr>
                                        <td>
                                            <span class="material-id text-primary">{{ material.material_id }}</span>
                                        </td>
                                        <td>
                                            <a href="{% url 'materials:material_detail' material.pk %}"
                                               class="text-decoration-none fw-medium text-dark"
                                               title="{{ material.material_name }}">
                                                <div class="text-truncate-custom">{{ material.material_name }}</div>
                                            </a>
                                        </td>
                                        <td>
                                            <div class="text-truncate-custom text-muted small" title="{{ material.manufacturer }}">
                                                {{ material.manufacturer|default:"-" }}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="text-truncate-custom text-muted small" title="{{ material.supplier }}">
                                                {{ material.supplier|default:"-" }}
                                            </div>
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ material.application|default:"-"|truncatechars:15 }}</small>
                                        </td>
                                        <td>
                                            {% if material.unit_price > 0 %}
                                            <span class="badge bg-success">
                                                ¥{{ material.unit_price|floatformat:0 }}
                                            </span>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if material.order_quantity > 0 %}
                                            <small class="text-info fw-medium">{{ material.order_quantity|floatformat:1 }}kg</small>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ material.material_category|default:"標準"|truncatechars:8 }}</span>
                                        </td>
                                        <td>
                                            <small class="text-muted" title="{{ material.remarks }}">
                                                {{ material.remarks|default:"-"|truncatechars:30 }}
                                            </small>
                                        </td>
                                        <td>
                                            <a href="{% url 'materials:material_detail' material.pk %}"
                                               class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="10" class="text-center py-4">
                                            <i class="fas fa-inbox text-muted fa-2x mb-2"></i>
                                            <br>
                                            <span class="text-muted">条件に一致する原料が見つかりません</span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ページネーション -->
        {% if page_obj.has_other_pages %}
        <div class="row mt-3">
            <div class="col">
                <nav>
                    <ul class="pagination pagination-sm justify-content-center">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query|urlencode }}{% endif %}{% if manufacturer_filter %}&manufacturer={{ manufacturer_filter|urlencode }}{% endif %}{% if supplier_filter %}&supplier={{ supplier_filter|urlencode }}{% endif %}{% if price_min %}&price_min={{ price_min }}{% endif %}{% if price_max %}&price_max={{ price_max }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}{% if manufacturer_filter %}&manufacturer={{ manufacturer_filter|urlencode }}{% endif %}{% if supplier_filter %}&supplier={{ supplier_filter|urlencode }}{% endif %}{% if price_min %}&price_min={{ price_min }}{% endif %}{% if price_max %}&price_max={{ price_max }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        </li>
                        {% endif %}

                        <!-- ページ番号の表示 -->
                        {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}{% if manufacturer_filter %}&manufacturer={{ manufacturer_filter|urlencode }}{% endif %}{% if supplier_filter %}&supplier={{ supplier_filter|urlencode }}{% endif %}{% if price_min %}&price_min={{ price_min }}{% endif %}{% if price_max %}&price_max={{ price_max }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}">{{ num }}</a>
                        </li>
                        {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}{% if manufacturer_filter %}&manufacturer={{ manufacturer_filter|urlencode }}{% endif %}{% if supplier_filter %}&supplier={{ supplier_filter|urlencode }}{% endif %}{% if price_min %}&price_min={{ price_min }}{% endif %}{% if price_max %}&price_max={{ price_max }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}">
                                <i class="fas fa-angle-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}{% if manufacturer_filter %}&manufacturer={{ manufacturer_filter|urlencode }}{% endif %}{% if supplier_filter %}&supplier={{ supplier_filter|urlencode }}{% endif %}{% if price_min %}&price_min={{ price_min }}{% endif %}{% if price_max %}&price_max={{ price_max }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
        {% endif %}

        <!-- フッター情報 -->
        <div class="row mt-3 mb-3">
            <div class="col text-center">
                <small class="text-muted">
                    原料管理システム - 全データ表示モード |
                    表示中: {{ page_obj.start_index }}-{{ page_obj.end_index }} / {{ total_count }}件 |
                    更新日時: {% now "Y-m-d H:i" %}
                </small>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function analyzeCSV() {
            const resultDiv = document.getElementById('csvAnalysisResult');
            const contentDiv = document.getElementById('csvAnalysisContent');

            // ローディング表示
            contentDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>分析中...</div>';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch('{% url "materials:analyze_csv_structure" %}');
                const data = await response.json();

                if (data.error) {
                    contentDiv.innerHTML = `<div class="alert alert-danger alert-sm"><i class="fas fa-exclamation-triangle me-2"></i>${data.error}</div>`;
                    return;
                }

                // 分析結果の表示
                let html = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="alert alert-info alert-sm">
                                <h6><i class="fas fa-info-circle me-2"></i>ファイル情報</h6>
                                <small>
                                    <ul class="mb-0">
                                        <li>エンコーディング: <strong>${data.encoding}</strong></li>
                                        <li>総行数: <strong>${data.total_rows}</strong>行</li>
                                        <li>列数: <strong>${data.columns.length}</strong>列</li>
                                    </ul>
                                </small>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="alert alert-success alert-sm">
                                <h6><i class="fas fa-columns me-2"></i>検出された列</h6>
                                <div class="small">
                                    ${data.columns.slice(0, 10).map(col => `<span class="badge bg-light text-dark me-1 mb-1">${col}</span>`).join('')}
                                    ${data.columns.length > 10 ? '<span class="text-muted">...他' + (data.columns.length - 10) + '列</span>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                contentDiv.innerHTML = html;

            } catch (error) {
                contentDiv.innerHTML = `<div class="alert alert-danger alert-sm"><i class="fas fa-exclamation-triangle me-2"></i>分析中にエラーが発生しました: ${error.message}</div>`;
            }
        }

        // テーブル行のホバー効果を強化
        document.addEventListener('DOMContentLoaded', function() {
            const rows = document.querySelectorAll('tbody tr');
            rows.forEach(row => {
                row.addEventListener('mouseenter', function() {
                    this.style.transform = 'scale(1.01)';
                    this.style.transition = 'transform 0.1s ease';
                });
                row.addEventListener('mouseleave', function() {
                    this.style.transform = 'scale(1)';
                });
            });
        });
    </script>
</body>
</html>